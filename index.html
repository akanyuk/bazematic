<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bazematic</title>
    <style>
        body {
            background-color: #444;
        }
        #fullscreen {
            position: absolute;
        }
        #bazematic {
            position: relative;
            width: 640px;
            height: 480px;
            margin: auto;
        }
        #jsspeccy {
            position: absolute;
        }
        #source {
            position: absolute;
            width: 640px;
            height: 480px;
            background-color: rgba(0, 0, 0, 0.3);
        }
        #source .ace_gutter {
            background: rgba(0, 0, 0, 0.3);
            color: #666;
        }
        #errors {
            position: absolute;
            bottom: 0;
            font-size: 12pt;
            margin: 0;
            padding: 0;
            color: #f00;
            z-index: 100;
        }
    </style>
    <script src="jsspeccy/jsspeccy.js"></script>
    <script src="ace/ace.js"></script>
    <script type="text/javascript">
const Z80_SOURCE = `    org 0x8000

    ld a,3
    out (254),a
loop
    jr loop
`;

    var Module = {
        onRuntimeInitialized: () => {
            const emu = JSSpeccy(
                document.getElementById('jsspeccy'),
                {zoom: 2, machine: 128, sandbox: true, autoStart: true, uiEnabled: false, keyboardEnabled: false}
            );

            const RasmAssemble = Module.cwrap('RasmAssembleInfo', 'number', ['string', 'number', 'number', 'number', 'number']);
            const RasmFreeInfoStruct = Module.cwrap('RasmFreeInfoStruct', 'void', ['number']);

            const destPtr = Module._malloc(4);
            const destLenPtr = Module._malloc(4);
            const infoPtr = Module._malloc(4);

            const assembleToSnapshot = (source) => {
                const result = RasmAssemble(source, source.length, destPtr, destLenPtr, infoPtr);
                const destLen = Module.getValue(destLenPtr, 'i32');
                const dest = Module.getValue(destPtr, 'i32');
                const info = Module.getValue(infoPtr, 'i32');
                let errorPtr = Module.getValue(info, 'i32');
                const nbError = Module.getValue(info + 4, 'i32');
                const maxError = Module.getValue(info + 8, 'i32');
                const warnErr = Module.getValue(info + 12, 'i32');
                if (result != 0) {
                    const errorMessages = [];
                    for (let i = 0; i < nbError; i++) {
                        const line = Module.getValue(errorPtr + 4, 'i32');
                        const msgPtr = Module.getValue(errorPtr + 8, 'i32');
                        const lenMsg = Module.getValue(errorPtr + 12, 'i32');
                        errorMessages.push("line " + line + ": " + Module.UTF8ToString(msgPtr, lenMsg));
                        errorPtr += 20;
                    }
                    RasmFreeInfoStruct(info);
                    return {success: false, errorMessages: errorMessages};
                } else {
                    const start = Module.getValue(info + 32, 'i32');
                    const destArray = new Uint8Array(Module.HEAPU8.buffer, dest, destLen);
                    RasmFreeInfoStruct(info);
                    Module._free(dest);

                    const snapshotMemory = new Uint8Array(0xc000);
                    for (let i=0; i < destLen; i++) {
                        snapshotMemory[start + i - 0x4000] = destArray[i];
                    }
                    const snapshot = {
                        registers: {
                            'AF': 0,
                            'BC': 0,
                            'HL': 0,
                            'PC': start,
                            'SP': start - 2,
                            'IR': 0,
                            'DE': 0,
                            'BC_': 0,
                            'DE_': 0,
                            'HL_': 0,
                            'AF_': 0,
                            'IY': 0x5c3a,
                            'IX': 0,
                            'iff1': 1,
                            'iff2': 1,
                            'im': 1,
                        },
                        ulaState: {
                            borderColour: 0,
                            pagingFlags: 0x10,
                        },
                        model: 128,
                        memoryPages: {
                            5: new Uint8Array(snapshotMemory.buffer, 0, 0x4000),
                            2: new Uint8Array(snapshotMemory.buffer, 0x4000, 0x4000),
                            0: new Uint8Array(snapshotMemory.buffer, 0x8000, 0x4000),
                        },
                        tstates: 0,
                    };
                    return {success: true, snapshot: snapshot};
                }
            }

            let result = assembleToSnapshot(Z80_SOURCE);
            emu.onReady(() => {
                emu.loadSnapshotFromStruct(result.snapshot);
            });
            const editor = ace.edit("source");
            editor.setTheme("ace/theme/twilight");
            editor.setShowPrintMargin(false);
            editor.setFontSize(16);
            // editor.session.setMode("ace/mode/assembly_z80");
            editor.session.setValue(Z80_SOURCE);
            editor.focus();

            const sourceElement = document.getElementById('source');
            const errorsElement = document.getElementById('errors');

            window.addEventListener("keydown", (event) => {
                if (event.code == 'KeyS' && (event.metaKey || event.ctrlKey)) {
                    event.preventDefault();
                    const result = assembleToSnapshot(editor.getValue());
                    if (result.success) {
                        errorsElement.innerText = "";
                        emu.loadSnapshotFromStruct(result.snapshot);
                    } else {
                        errorsElement.innerText = (result.errorMessages.join("\n"));
                    }
                } else if (event.code == 'KeyH' && (event.metaKey || event.ctrlKey)) {
                    event.preventDefault();
                    if (sourceElement.style.display == 'none') {
                        sourceElement.style.display = 'block';
                        errorsElement.style.display = 'block';
                        editor.focus();
                    } else {
                        sourceElement.style.display = 'none';
                        errorsElement.style.display = 'none';
                    }
                } else if (event.code == 'Enter' && (event.metaKey || event.ctrlKey)) {
                    event.preventDefault();
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        bazematic.requestFullscreen();
                    }
                }
            });

            const bazematic = document.getElementById('bazematic');
            document.getElementById('fullscreen').addEventListener('click', () => {
                bazematic.requestFullscreen();
            });
            const emuRoot = document.getElementById('jsspeccy');
            const emuCanvas = emuRoot.getElementsByTagName('canvas')[0];
            const emuWrapper = emuCanvas.parentElement;
            bazematic.addEventListener('fullscreenchange', () => {
                if (document.fullscreenElement) {
                    emuWrapper.style.height = window.screen.availHeight + 'px';
                    const emuWidth = window.screen.availHeight * 640/480;
                    emuWrapper.style.width = emuWidth + 'px';
                    emuWrapper.style.left = (window.screen.availWidth - emuWidth) / 2 + 'px';
                    emuCanvas.style.width = '100%';
                    emuCanvas.style.height = '100%';

                    sourceElement.style.height = window.screen.availHeight + 'px';
                    sourceElement.style.width = emuWidth + 'px';
                    sourceElement.style.left = (window.screen.availWidth - emuWidth) / 2 + 'px';
                    errorsElement.style.left = (window.screen.availWidth - emuWidth) / 2 + 'px';
                } else {
                    emuRoot.style.position = 'absolute';
                    emuCanvas.style.width = '640px';
                    emuCanvas.style.height = '480px';
                    emuWrapper.style.left = '0px';
                    emuWrapper.style.width = '640px';
                    emuWrapper.style.height = '480px';

                    sourceElement.style.width = '640px';
                    sourceElement.style.height = '480px';
                    sourceElement.style.left = '0px';
                    errorsElement.style.left = '0px';
                }
            });
        }
    };
    </script>
    <script src="rasm/rasm.js"></script>
</head>
<body>
    <button id="fullscreen">Fullscreen</button>
    <div id="bazematic">
        <div id="jsspeccy"></div>
        <div id="source"></div>
        <pre id="errors"></pre>
    </div>
</body>
</html>
